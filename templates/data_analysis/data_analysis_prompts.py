# -*- coding: utf-8 -*-
"""
데이터 분석 프롬프트 V2.2 - Actionability 강화

핵심 개선: 실행가능성(Actionability) 7.95 → 9.0 목표
- STEP 4 권고사항을 "실행 계획서" 수준으로 강화
- 5W1H 기반 액션 아이템 (Who, What, When, How, 기대효과)
- 정량적 ROI 및 리스크 분석 포함

카테고리: interpretation, insight, visualization, sql_query, statistics, dashboard, ab_test, ml_interpretation
"""

from typing import List


def _build_checklist(expected_elements: List[str]) -> str:
    """expected_elements를 분석 체크리스트로 변환"""
    if not expected_elements:
        return "- 일반적인 분석 수행"

    items = []
    for i, elem in enumerate(expected_elements, 1):
        items.append(f"| {i} | **{elem}** | 검토 필요 |")

    header = "| 번호 | 분석 항목 | 상태 |\n|------|----------|------|\n"
    return header + "\n".join(items)


def _build_analysis_sections(expected_elements: List[str]) -> str:
    """expected_elements를 분석 섹션으로 변환 (V2.2: 액션 아이템 포함)"""
    if not expected_elements:
        return ""

    sections = []
    for i, elem in enumerate(expected_elements, 1):
        sections.append(f"""
#### 분석 {i}: {elem}
- **분석 결과**: [구체적 수치와 함께 기술]
- **근거 데이터**: [해당 데이터 인용]
- **의미/해석**: [비즈니스 관점 해석]
- **즉시 실행 가능한 액션**: [이 분석 결과로 당장 할 수 있는 구체적 행동 1가지]
""")
    return "\n".join(sections)


# ============================================================================
# V2.2 강화된 권고사항 섹션 템플릿
# ============================================================================

ACTION_PLAN_TEMPLATE = """
### STEP 4: 실행 계획서 (Action Plan)

#### 우선순위 1: [가장 중요한 액션]
| 항목 | 내용 |
|------|------|
| **무엇을(What)** | [구체적 액션 - 동사로 시작] |
| **누가(Who)** | [담당 부서/역할: 마케팅팀, 데이터팀, 경영진 등] |
| **언제까지(When)** | [기한: 즉시/1주 내/1개월 내] |
| **어떻게(How)** | [실행 단계: 1) → 2) → 3)] |
| **기대 효과** | [정량적 수치: 매출 X% 증가, 비용 Y원 절감 등] |
| **리스크** | [실행 시 예상 장애물 및 대응책] |

#### 우선순위 2: [두 번째 액션]
| 항목 | 내용 |
|------|------|
| **무엇을(What)** | [구체적 액션] |
| **누가(Who)** | [담당 부서/역할] |
| **언제까지(When)** | [기한] |
| **어떻게(How)** | [실행 단계] |
| **기대 효과** | [정량적 수치] |

#### 우선순위 3: [세 번째 액션]
| 항목 | 내용 |
|------|------|
| **무엇을(What)** | [구체적 액션] |
| **누가(Who)** | [담당 부서/역할] |
| **언제까지(When)** | [기한] |
| **기대 효과** | [정량적 수치] |

---

### 실행 체크리스트

다음 주 월요일까지 완료해야 할 항목:
- [ ] [구체적 태스크 1]
- [ ] [구체적 태스크 2]
- [ ] [구체적 태스크 3]

**예상 총 ROI**: [투입 비용 대비 기대 효과 요약]
"""


# ============================================================================
# 데이터 해석 프롬프트
# ============================================================================

INTERPRETATION_TEMPLATE = """### 역할
당신은 10년 경력의 데이터 분석가입니다.

**3가지 원칙:**
1. **숫자로 말하기** - 모든 주장에 구체적 수치 근거
2. **So What?** - 단순 기술이 아닌 비즈니스 의미 해석
3. **액션 연결** - 분석 결과를 실행 가능한 제안으로 연결

---

### 분석 대상
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 원본 데이터
```
{raw_data}
```

---

### 필수 분석 체크리스트

아래 항목을 **반드시** 분석에 포함하세요.

{checklist}

---

### STEP 1: 데이터 개요 파악 (30초)

- 데이터 구조: [행/열 수, 주요 변수]
- 기간/범위: [데이터가 커버하는 범위]
- 데이터 품질: [결측치, 이상치 여부]

---

### STEP 2: 체크리스트 기반 상세 분석

{analysis_sections}

---

### STEP 3: 종합 인사이트

| 순위 | 핵심 발견 | 비즈니스 영향 | 긴급도 |
|------|----------|--------------|--------|
| 1 | [가장 중요한 발견] | [정량적 영향: 매출/비용/효율] | 즉시/1주/1개월 |
| 2 | [두 번째 발견] | [정량적 영향] | 즉시/1주/1개월 |
| 3 | [세 번째 발견] | [정량적 영향] | 즉시/1주/1개월 |

---

### STEP 4: 실행 계획서 (Action Plan)

#### 우선순위 1: [가장 중요한 액션]
| 항목 | 내용 |
|------|------|
| **무엇을(What)** | [구체적 액션 - 동사로 시작. 예: "A 세그먼트 대상 프로모션 실행"] |
| **누가(Who)** | [담당 부서/역할: 마케팅팀, 데이터팀, 영업팀 등] |
| **언제까지(When)** | [기한: 즉시/3일 내/1주 내/1개월 내] |
| **어떻게(How)** | [실행 단계: 1) 대상 선정 → 2) 메시지 작성 → 3) 발송 → 4) 성과 측정] |
| **기대 효과** | [정량적 수치: 매출 15% 증가, 비용 200만원 절감, 전환율 2%p 상승 등] |
| **리스크 및 대응** | [예상 장애물과 해결책] |

#### 우선순위 2: [두 번째 액션]
| 항목 | 내용 |
|------|------|
| **무엇을(What)** | [구체적 액션] |
| **누가(Who)** | [담당 부서/역할] |
| **언제까지(When)** | [기한] |
| **어떻게(How)** | [실행 단계] |
| **기대 효과** | [정량적 수치] |

#### 우선순위 3: [세 번째 액션]
| 항목 | 내용 |
|------|------|
| **무엇을(What)** | [구체적 액션] |
| **누가(Who)** | [담당 부서/역할] |
| **언제까지(When)** | [기한] |
| **기대 효과** | [정량적 수치] |

---

### 실행 체크리스트

이번 주 완료 항목:
- [ ] [구체적 태스크 1 - 담당자 지정]
- [ ] [구체적 태스크 2 - 데이터 준비]
- [ ] [구체적 태스크 3 - 실행 및 모니터링]

**예상 총 ROI**: [예: 투입 공수 8시간 → 예상 효과 월 500만원 = ROI 625%]
"""


# ============================================================================
# 인사이트 도출 프롬프트
# ============================================================================

INSIGHT_TEMPLATE = """### 역할
당신은 전략 컨설턴트 출신 데이터 사이언티스트입니다.

**3가지 원칙:**
1. **Why 5번** - 표면적 현상 뒤의 근본 원인 탐색
2. **비교 분석** - 벤치마크, 시계열, 세그먼트 비교
3. **실행 가능성** - 조직이 바로 적용할 수 있는 인사이트

---

### 분석 대상
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 원본 데이터
```
{raw_data}
```

---

### 필수 인사이트 체크리스트

아래 관점에서 **반드시** 인사이트를 도출하세요.

{checklist}

---

### STEP 1: 패턴 식별 (1분)

- 눈에 띄는 패턴: [증가/감소/변동 패턴]
- 이상 징후: [평균에서 벗어난 데이터]
- 상관관계: [변수 간 관계]

---

### STEP 2: 체크리스트 기반 인사이트 도출

{analysis_sections}

---

### STEP 3: 인사이트 우선순위화

| 인사이트 | 영향도 | 실행 용이성 | 예상 효과 | 우선순위 |
|----------|--------|------------|----------|----------|
| [인사이트1] | 상/중/하 | 상/중/하 | [정량적 효과] | 1 |
| [인사이트2] | 상/중/하 | 상/중/하 | [정량적 효과] | 2 |
| [인사이트3] | 상/중/하 | 상/중/하 | [정량적 효과] | 3 |

---

### STEP 4: 실행 계획서 (Action Plan)

#### Quick Win (1주 내 실행)
| 항목 | 내용 |
|------|------|
| **액션** | [구체적 행동 - 동사로 시작] |
| **담당** | [부서/역할] |
| **기한** | [D+3, D+7 등 구체적 날짜] |
| **실행 단계** | 1) [첫 번째] → 2) [두 번째] → 3) [세 번째] |
| **기대 효과** | [정량적: 매출 X% 증가, 비용 Y원 절감] |
| **성공 지표** | [측정 가능한 KPI] |

#### 중기 과제 (1-3개월)
| 항목 | 내용 |
|------|------|
| **액션** | [구체적 행동] |
| **담당** | [부서/역할] |
| **마일스톤** | [1개월: A 완료 → 2개월: B 완료 → 3개월: C 완료] |
| **필요 리소스** | [예산, 인력, 시스템] |
| **기대 효과** | [정량적 효과] |

#### 장기 전략 (3개월+)
| 항목 | 내용 |
|------|------|
| **전략 방향** | [큰 그림] |
| **선행 조건** | [먼저 완료되어야 할 것] |
| **투자 규모** | [예상 비용/시간] |
| **기대 ROI** | [투자 대비 효과] |

---

### 이번 주 액션 아이템

- [ ] [태스크 1: 담당자, 기한]
- [ ] [태스크 2: 담당자, 기한]
- [ ] [태스크 3: 담당자, 기한]
"""


# ============================================================================
# 시각화 제안 프롬프트
# ============================================================================

VISUALIZATION_TEMPLATE = """### 역할
당신은 데이터 시각화 전문가입니다.

**3가지 원칙:**
1. **목적 중심** - 전달하려는 메시지에 맞는 차트 선택
2. **단순함** - 불필요한 요소 제거, 핵심만 강조
3. **접근성** - 누구나 이해할 수 있는 시각화

---

### 시각화 대상
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 원본 데이터
```
{raw_data}
```

---

### 필수 시각화 요소 체크리스트

아래 항목을 **반드시** 제안에 포함하세요.

{checklist}

---

### STEP 1: 데이터 특성 파악

- 데이터 유형: [범주형/수치형/시계열/지리]
- 비교 대상: [항목 간/시간별/구성비]
- 청중: [경영진/실무자/외부]

---

### STEP 2: 체크리스트 기반 시각화 설계

{analysis_sections}

---

### STEP 3: 최종 시각화 제안

#### 메인 차트
- **차트 유형**: [바/라인/파이/산점도 등]
- **X축**: [변수명]
- **Y축**: [변수명]
- **색상**: [의미 있는 색상 사용]

#### 보조 시각화
| 목적 | 차트 유형 | 표시 데이터 |
|------|----------|-----------|
| [목적1] | [차트] | [데이터] |
| [목적2] | [차트] | [데이터] |

---

### STEP 4: 구현 실행 계획

#### 도구 및 환경
| 항목 | 권장 | 대안 |
|------|------|------|
| **도구** | [Tableau/Power BI/Python] | [Excel/Google Sheets] |
| **소요 시간** | [예: 2시간] | - |
| **필요 스킬** | [기본/중급/고급] | - |

#### 구현 단계 (Step-by-Step)
| 단계 | 작업 | 소요 시간 | 산출물 |
|------|------|----------|--------|
| 1 | [데이터 전처리: 결측치 처리, 형식 변환] | [30분] | [정제된 데이터셋] |
| 2 | [차트 생성: X축, Y축, 색상 설정] | [30분] | [기본 차트] |
| 3 | [스타일링: 제목, 범례, 주석 추가] | [30분] | [완성 차트] |
| 4 | [검토: 메시지 전달력 확인] | [30분] | [최종 시각화] |

#### 체크리스트
- [ ] 데이터 소스 연결 완료
- [ ] 핵심 메시지가 3초 안에 파악되는가?
- [ ] 색상이 직관적인가? (좋음=녹색, 나쁨=빨강)
- [ ] 불필요한 요소 제거했는가?

**즉시 시작하려면**: [첫 번째로 해야 할 구체적 행동]
"""


# ============================================================================
# 프롬프트 생성 함수
# ============================================================================

def get_interpretation_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """데이터 해석 프롬프트 생성"""
    return INTERPRETATION_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


def get_insight_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """인사이트 도출 프롬프트 생성"""
    return INSIGHT_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


def get_visualization_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """시각화 제안 프롬프트 생성"""
    return VISUALIZATION_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


# ============================================================================
# SQL 쿼리 작성 프롬프트
# ============================================================================

SQL_QUERY_TEMPLATE = """### 역할
당신은 10년 경력의 데이터 엔지니어입니다.

**3가지 원칙:**
1. **정확성** - 정확한 결과를 반환하는 쿼리 작성
2. **효율성** - 최적화된 쿼리로 성능 보장
3. **가독성** - 유지보수가 쉬운 코드 작성

---

### 분석 요청
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 테이블 스키마
```
{raw_data}
```

---

### 필수 쿼리 요소 체크리스트

아래 항목을 **반드시** 쿼리에 포함하세요.

{checklist}

---

### STEP 1: 요구사항 분석

- 추출 대상: [어떤 데이터를 추출해야 하는가]
- 필터 조건: [WHERE 조건이 될 항목들]
- 집계 방식: [GROUP BY, 집계 함수 필요 여부]
- 정렬 기준: [ORDER BY 필요 여부]

---

### STEP 2: 체크리스트 기반 쿼리 설계

{analysis_sections}

---

### STEP 3: 최종 SQL 쿼리

```sql
-- 쿼리 목적: [한 줄 설명]
-- 작성자: 데이터팀
-- 최종 수정: [날짜]

[SQL 쿼리 작성]
```

---

### STEP 4: 실행 및 활용 가이드

#### 쿼리 구성 요소 설명
| 구성 요소 | 설명 | 최적화 포인트 |
|----------|------|--------------|
| SELECT | [선택 컬럼 설명] | [필요한 컬럼만 선택] |
| FROM/JOIN | [테이블 관계] | [인덱스 활용 여부] |
| WHERE | [필터 조건] | [인덱스 컬럼 우선] |
| GROUP BY | [집계 기준] | [집계 전 필터링] |

#### 실행 전 체크리스트
- [ ] 테스트 환경에서 먼저 실행 (LIMIT 100 추가)
- [ ] 예상 결과 건수 확인
- [ ] 실행 계획(EXPLAIN) 검토
- [ ] 권한 확인 (SELECT 권한 필요)

#### 실행 단계
| 단계 | 작업 | 담당 | 주의사항 |
|------|------|------|---------|
| 1 | 테스트 실행 | [데이터팀] | LIMIT 절 추가 |
| 2 | 결과 검증 | [분석가] | 샘플 데이터 확인 |
| 3 | 본 실행 | [데이터팀] | 피크 시간 피하기 |
| 4 | 결과 저장 | [분석가] | CSV/테이블 저장 |

#### 결과 활용 방안
| 활용처 | 담당 부서 | 액션 |
|--------|----------|------|
| [리포트] | [분석팀] | [주간 리포트에 포함] |
| [대시보드] | [BI팀] | [KPI 차트 업데이트] |
| [알림] | [운영팀] | [임계값 초과 시 알림 설정] |

**예상 실행 시간**: [대략적 추정]
**다음 단계**: [이 쿼리 결과로 무엇을 해야 하는가?]
"""


# ============================================================================
# 통계 분석 프롬프트
# ============================================================================

STATISTICS_TEMPLATE = """### 역할
당신은 통계학 박사 출신 데이터 사이언티스트입니다.

**3가지 원칙:**
1. **가설 기반** - 명확한 귀무가설과 대립가설 설정
2. **적절한 검정** - 데이터 특성에 맞는 통계 검정 선택
3. **실용적 해석** - p-value 넘어 실질적 의미 해석

---

### 분석 대상
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 원본 데이터
```
{raw_data}
```

---

### 필수 통계 분석 체크리스트

아래 항목을 **반드시** 분석에 포함하세요.

{checklist}

---

### STEP 1: 데이터 특성 파악

- 변수 유형: [연속형/범주형/순서형]
- 분포 형태: [정규성 여부, 이상치]
- 표본 크기: [n 값, 검정력 고려]
- 독립성: [관측치 독립 여부]

---

### STEP 2: 체크리스트 기반 통계 분석

{analysis_sections}

---

### STEP 3: 가설 검정

| 검정 항목 | 귀무가설 | 검정 방법 | 결과 |
|----------|---------|----------|------|
| [항목1] | H0: [가설] | [t-test/ANOVA/chi-square 등] | p=[값] |
| [항목2] | H0: [가설] | [검정 방법] | p=[값] |

**효과 크기(Effect Size)**: [Cohen's d, eta-squared 등]

---

### STEP 4: 결론 및 실행 계획

#### 통계적 결론
| 가설 | 결과 | 신뢰도 | 비즈니스 의미 |
|------|------|--------|--------------|
| [H0] | [기각/채택] | [95%/99%] | [한 문장 해석] |

#### 의사결정 권고
| 결정 사항 | 권고안 | 근거 | 리스크 |
|----------|--------|------|--------|
| [주요 결정] | [A안/B안 선택] | [통계적 근거] | [틀릴 확률] |

#### 실행 계획
| 우선순위 | 액션 | 담당 | 기한 | 기대 효과 |
|----------|------|------|------|----------|
| 1 | [구체적 행동] | [부서] | [기한] | [정량적 효과] |
| 2 | [구체적 행동] | [부서] | [기한] | [정량적 효과] |

#### 후속 분석 필요 사항
| 분석 주제 | 필요 데이터 | 담당 | 기한 |
|----------|-----------|------|------|
| [추가 분석1] | [필요 데이터] | [담당자] | [기한] |

#### 체크리스트
- [ ] 분석 결과 이해관계자 공유 완료
- [ ] 의사결정 회의 일정 잡기
- [ ] 실행 담당자 지정

**다음 액션**: [가장 먼저 해야 할 일 1가지]
"""


# ============================================================================
# 대시보드 설계 프롬프트
# ============================================================================

DASHBOARD_TEMPLATE = """### 역할
당신은 BI(Business Intelligence) 전문 컨설턴트입니다.

**3가지 원칙:**
1. **사용자 중심** - 의사결정자가 필요한 정보 우선
2. **액션 유도** - 대시보드가 행동으로 연결되도록
3. **심플함** - 정보 과부하 방지, 핵심 지표 집중

---

### 대시보드 요청
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 사용 가능한 데이터
```
{raw_data}
```

---

### 필수 대시보드 요소 체크리스트

아래 항목을 **반드시** 설계에 포함하세요.

{checklist}

---

### STEP 1: 사용자 분석

- 주 사용자: [경영진/팀장/실무자]
- 사용 빈도: [일간/주간/월간]
- 핵심 질문: [대시보드로 답해야 할 질문]
- 의사결정: [어떤 결정을 내리는 데 사용?]

---

### STEP 2: 체크리스트 기반 KPI 설계

{analysis_sections}

---

### STEP 3: 대시보드 레이아웃

#### 상단 영역 (Executive Summary)
| 위치 | KPI | 시각화 | 새로고침 |
|------|-----|--------|---------|
| 좌측 | [핵심 지표1] | [숫자 카드] | [빈도] |
| 중앙 | [핵심 지표2] | [게이지] | [빈도] |
| 우측 | [핵심 지표3] | [추세선] | [빈도] |

#### 중단 영역 (상세 분석)
| 차트 | 목적 | X축 | Y축 | 필터 |
|------|------|-----|-----|------|
| [차트1] | [목적] | [변수] | [변수] | [조건] |
| [차트2] | [목적] | [변수] | [변수] | [조건] |

#### 하단 영역 (상세 데이터)
- [테이블/드릴다운 설명]

---

### STEP 4: 구현 실행 계획

#### 도구 및 환경
| 항목 | 권장 | 대안 | 비용 |
|------|------|------|------|
| **BI 도구** | [Tableau/Power BI] | [Metabase/Looker] | [라이선스 비용] |
| **데이터 소스** | [DW/데이터 마트] | [직접 연결] | - |
| **새로고침** | [일간/실시간] | - | - |

#### 구현 로드맵
| 주차 | 작업 | 담당 | 산출물 | 완료 기준 |
|------|------|------|--------|----------|
| 1주 | 데이터 연결 및 모델링 | [BI팀] | 데이터 모델 | 모든 KPI 계산 가능 |
| 2주 | 차트 개발 | [BI팀] | 초안 대시보드 | 레이아웃 확정 |
| 3주 | 사용자 테스트 | [현업] | 피드백 | 주요 피드백 반영 |
| 4주 | 배포 및 교육 | [BI팀] | 최종 버전 | 사용자 교육 완료 |

#### 인터랙션 설계
| 필터 | 적용 범위 | 기본값 |
|------|----------|--------|
| 날짜 | 전체 | 최근 30일 |
| 부서 | 전체 | 전체 |
| [추가 필터] | [범위] | [기본값] |

#### 알림 설정
| 조건 | 임계값 | 수신자 | 채널 |
|------|--------|--------|------|
| [KPI1 이상] | [값] | [담당자] | [이메일/Slack] |
| [KPI2 이상] | [값] | [담당자] | [이메일/Slack] |

#### 체크리스트
- [ ] 데이터 소스 권한 확보
- [ ] 주요 이해관계자 요구사항 확인
- [ ] 모바일 대응 필요 여부 확인
- [ ] 보안 요건 검토

**다음 액션**: [1주차 시작 전 해야 할 일]
"""


# ============================================================================
# A/B 테스트 분석 프롬프트
# ============================================================================

AB_TEST_TEMPLATE = """### 역할
당신은 실험 설계 전문 그로스 해커입니다.

**3가지 원칙:**
1. **과학적 엄밀성** - 통계적으로 유효한 실험 설계
2. **비즈니스 연결** - 지표 개선이 매출에 미치는 영향
3. **실행 가능성** - 바로 적용 가능한 결론 도출

---

### 실험 정보
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 실험 결과 데이터
```
{raw_data}
```

---

### 필수 분석 체크리스트

아래 항목을 **반드시** 분석에 포함하세요.

{checklist}

---

### STEP 1: 실험 설계 검토

- 가설: [변경 사항이 가져올 효과]
- 주요 지표: [전환율/매출/체류시간 등]
- 표본 크기: [각 그룹 n, 검정력]
- 실험 기간: [충분한 기간 확보 여부]
- 무작위 배정: [랜덤화 방법]

---

### STEP 2: 체크리스트 기반 결과 분석

{analysis_sections}

---

### STEP 3: 통계적 검증

| 지표 | Control | Treatment | 차이 | p-value | 유의성 |
|------|---------|-----------|------|---------|--------|
| [지표1] | [값] | [값] | [%] | [p] | [O/X] |
| [지표2] | [값] | [값] | [%] | [p] | [O/X] |

**신뢰구간 (95%)**: [하한 ~ 상한]
**최소 감지 효과(MDE)**: [설정값 vs 실제]

---

### STEP 4: 의사결정 및 실행 계획

#### 실험 결론
| 항목 | 내용 |
|------|------|
| **결론** | [승자: Treatment / Control 유지 / 추가 실험 필요] |
| **신뢰도** | [95% / 99%] |
| **효과 크기** | [+X% / -Y%] |

#### 비즈니스 임팩트 계산
| 지표 | 현재 | 예상 | 연간 효과 |
|------|------|------|----------|
| [전환율] | [X%] | [Y%] | [+Z건] |
| [매출] | [X원] | [Y원] | [+Z원] |
| [비용] | [X원] | [Y원] | [-Z원] |

**예상 ROI**: [실험 비용 X원 → 연간 효과 Y원 = ROI Z%]

#### 실행 계획
| 단계 | 작업 | 담당 | 기한 | 완료 기준 |
|------|------|------|------|----------|
| 1 | 결과 공유 회의 | [PM] | [D+1] | 이해관계자 동의 |
| 2 | 승자 안 전체 적용 | [개발팀] | [D+7] | 100% 트래픽 |
| 3 | 성과 모니터링 | [분석팀] | [D+30] | 예상 효과 달성 |
| 4 | 후속 실험 설계 | [PM] | [D+14] | 다음 실험 가설 |

#### 롤아웃 계획
| 단계 | 트래픽 비율 | 기간 | 롤백 조건 |
|------|-----------|------|----------|
| Phase 1 | 10% | 3일 | [지표] -5% 이상 하락 시 |
| Phase 2 | 50% | 7일 | [지표] -3% 이상 하락 시 |
| Phase 3 | 100% | - | 안정화 완료 |

#### 체크리스트
- [ ] 실험 결과 문서화 완료
- [ ] 이해관계자 승인 획득
- [ ] 개발팀 배포 일정 확정
- [ ] 모니터링 대시보드 준비
- [ ] 롤백 플랜 수립

**다음 액션**: [내일까지 해야 할 일 1가지]
"""


# ============================================================================
# ML 결과 해석 프롬프트
# ============================================================================

ML_INTERPRETATION_TEMPLATE = """### 역할
당신은 Explainable AI(설명 가능한 AI) 전문가입니다.

**3가지 원칙:**
1. **투명성** - 모델이 왜 이런 예측을 했는지 설명
2. **신뢰성** - 모델의 한계와 불확실성 명시
3. **실용성** - 비즈니스 담당자도 이해할 수 있게 전달

---

### 모델 정보
- **시나리오**: {scenario}
- **산업**: {industry}
- **데이터 설명**: {data_description}

### 모델 출력/결과
```
{raw_data}
```

---

### 필수 해석 체크리스트

아래 항목을 **반드시** 해석에 포함하세요.

{checklist}

---

### STEP 1: 모델 개요

- 모델 유형: [분류/회귀/클러스터링]
- 타겟 변수: [예측 대상]
- 주요 피처: [입력 변수]
- 성능 지표: [정확도/AUC/RMSE 등]

---

### STEP 2: 체크리스트 기반 결과 해석

{analysis_sections}

---

### STEP 3: 예측 결과 분석

#### 전체 성능
| 지표 | 값 | 해석 |
|------|------|------|
| [정확도/AUC] | [값] | [좋음/보통/개선필요] |
| [정밀도/재현율] | [값] | [비즈니스 맥락 해석] |

#### 피처 중요도
| 순위 | 피처 | 중요도 | 비즈니스 의미 |
|------|------|--------|--------------|
| 1 | [피처1] | [값] | [해석] |
| 2 | [피처2] | [값] | [해석] |
| 3 | [피처3] | [값] | [해석] |

#### 예측 신뢰도
- 고신뢰 예측: [비율, 특성]
- 저신뢰 예측: [비율, 주의점]

---

### STEP 4: 비즈니스 활용 및 실행 계획

#### 모델 적용 가이드
| 사용 사례 | 적합도 | 기대 효과 | 주의사항 |
|----------|--------|----------|---------|
| [사용 사례 1] | 높음/보통/낮음 | [정량적 효과] | [주의점] |
| [사용 사례 2] | 높음/보통/낮음 | [정량적 효과] | [주의점] |
| [부적합 사례] | 부적합 | - | [사용하면 안 되는 이유] |

#### 배포 계획
| 단계 | 작업 | 담당 | 기한 | 완료 기준 |
|------|------|------|------|----------|
| 1 | 모델 검증 (A/B) | [ML팀] | [D+7] | 성능 기준 충족 |
| 2 | API 개발 | [개발팀] | [D+14] | 엔드포인트 배포 |
| 3 | 통합 테스트 | [QA팀] | [D+21] | 모든 테스트 통과 |
| 4 | 프로덕션 배포 | [DevOps] | [D+28] | 100% 트래픽 |

#### 모니터링 설정
| 지표 | 임계값 | 알림 조건 | 담당 |
|------|--------|----------|------|
| 정확도 | [X%] | X% 미만 시 | [ML팀] |
| 예측 지연 | [Xms] | X ms 초과 시 | [DevOps] |
| 드리프트 | [PSI X] | X 초과 시 | [ML팀] |

#### 재학습 계획
| 조건 | 주기 | 담당 | 예상 소요 |
|------|------|------|----------|
| 정기 재학습 | [월간/분기] | [ML팀] | [X시간] |
| 성능 저하 시 | 즉시 | [ML팀] | [X시간] |
| 데이터 변화 시 | 필요 시 | [ML팀] | [X시간] |

#### 체크리스트
- [ ] 모델 카드 문서화 완료
- [ ] 편향 테스트 완료
- [ ] 롤백 플랜 수립
- [ ] 모니터링 대시보드 설정
- [ ] 재학습 파이프라인 구축

**다음 액션**: [모델 배포 전 가장 먼저 해야 할 일]
"""


# ============================================================================
# 추가 프롬프트 생성 함수
# ============================================================================

def get_sql_query_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """SQL 쿼리 작성 프롬프트 생성"""
    return SQL_QUERY_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


def get_statistics_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """통계 분석 프롬프트 생성"""
    return STATISTICS_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


def get_dashboard_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """대시보드 설계 프롬프트 생성"""
    return DASHBOARD_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


def get_ab_test_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """A/B 테스트 분석 프롬프트 생성"""
    return AB_TEST_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


def get_ml_interpretation_prompt(
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """ML 결과 해석 프롬프트 생성"""
    return ML_INTERPRETATION_TEMPLATE.format(
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        checklist=_build_checklist(expected_elements),
        analysis_sections=_build_analysis_sections(expected_elements)
    )


# ============================================================================
# 카테고리별 프롬프트 매핑
# ============================================================================

PROMPT_FUNCTIONS = {
    "interpretation": get_interpretation_prompt,
    "insight": get_insight_prompt,
    "visualization": get_visualization_prompt,
    "sql_query": get_sql_query_prompt,
    "statistics": get_statistics_prompt,
    "dashboard": get_dashboard_prompt,
    "ab_test": get_ab_test_prompt,
    "ml_interpretation": get_ml_interpretation_prompt,
}


def get_prompt_by_category(
    category: str,
    scenario: str,
    industry: str,
    data_description: str,
    raw_data: str,
    expected_elements: List[str]
) -> str:
    """카테고리에 맞는 프롬프트 생성"""
    if category not in PROMPT_FUNCTIONS:
        raise ValueError(f"지원하지 않는 카테고리: {category}")

    return PROMPT_FUNCTIONS[category](
        scenario=scenario,
        industry=industry,
        data_description=data_description,
        raw_data=raw_data,
        expected_elements=expected_elements
    )
